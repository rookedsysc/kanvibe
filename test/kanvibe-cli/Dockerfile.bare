# KanVibe CLI 테스트용 Docker 이미지
# Ubuntu 환경에서 kanvibe.sh 전체 흐름을 테스트한다.
#
# 빌드:
#   docker build -t kanvibe-cli-bare -f test/kanvibe-cli/Dockerfile.bare .
#
# 실행 (Docker 소켓 마운트 필요):
#   docker run --rm -it -v /var/run/docker.sock:/var/run/docker.sock kanvibe-cli-bare bash kanvibe.sh start
#   docker run --rm -it -v /var/run/docker.sock:/var/run/docker.sock -e LANG=ko_KR.UTF-8 kanvibe-cli-bare bash kanvibe.sh start
#
# 의존성 체크만 테스트 (Docker 소켓 불필요):
#   docker run --rm -it kanvibe-cli-bare bash kanvibe.sh

FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=en_US.UTF-8

# git, curl, sudo, locales + Docker CLI (데몬 없이 CLI만 사용)
RUN apt-get update && apt-get install -y \
    git \
    curl \
    sudo \
    vim \
    locales \
    ca-certificates \
    gnupg \
    && locale-gen en_US.UTF-8 ko_KR.UTF-8 zh_CN.UTF-8 \
    && install -m 0755 -d /etc/apt/keyrings \
    && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg \
    && chmod a+r /etc/apt/keyrings/docker.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
    $(. /etc/os-release && echo "$VERSION_CODENAME") stable" > /etc/apt/sources.list.d/docker.list \
    && apt-get update \
    && apt-get install -y docker-ce-cli docker-compose-plugin \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
RUN git clone https://github.com/rookedsysc/kanvibe .
RUN cp .env.example .env

CMD ["bash"]
